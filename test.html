<!DOCTYPE html>
<html>
<head>
  <title>Bangle.js Accelerometer Dashboard</title>
  <script src="https://www.puck-js.com/puck.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r99/three.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
    }
    #panel2d, #panel3d {
      flex: 1;
      height: 100vh;
      box-sizing: border-box;
      padding: 10px;
    }
    .bar {
      width : 500px;
      height: 24px;
      background-color : #D0D0D0;
      position:relative;
      display: inline-block;
    }
    .bar span {
      width : 1px;
      height: 20px;
      background-color : red;
      position:absolute;
      display: inline-block;
      left: 150px;
      top: 2px;
    }
    #btnConnect {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button id="btnConnect">Connect</button>

  <!-- Painel 2D com barras -->
  <div id="panel2d">
    <p>X: <span class="bar"><span id="barX"></span></span></p>
    <p>Y: <span class="bar"><span id="barY"></span></span></p>
    <p>Z: <span class="bar"><span id="barZ"></span></span></p>
  </div>

  <!-- Painel 3D -->
  <div id="panel3d"></div>

<script>
// Código a ser enviado ao Bangle.js
var BANGLE_CODE = `
Bangle.on('accel',function(a) {
  var d = [
    "A",
    Math.round(a.x*100),
    Math.round(a.y*100),
    Math.round(a.z*100)
    ];
  Bluetooth.println(d.join(","));
})
`;

let connection;
let accel = new THREE.Vector3(0, 0, 1);

// Conexão com o Bangle.js
document.getElementById("btnConnect").addEventListener("click", function() {
  if (connection) {
    connection.close();
    connection = undefined;
    return;
  }

  Puck.connect(function(c) {
    if (!c) {
      alert("Couldn't connect!");
      return;
    }
    connection = c;
    var buf = "";
    connection.on("data", function(d) {
      buf += d;
      var l = buf.split("\n");
      buf = l.pop();
      l.forEach(onLine);
    });

    connection.write("reset();\n", function() {
      setTimeout(function() {
        connection.write("\x03\x10if(1){"+BANGLE_CODE+"}\n",
          function() { console.log("Ready..."); });
      }, 1500);
    });
  });
});

// Processa os dados recebidos
function onLine(line) {
  console.log("RECEIVED:" + line);
  var d = line.split(",");
  if (d.length == 4 && d[0] == "A") {
    const x = parseInt(d[1]);
    const y = parseInt(d[2]);
    const z = parseInt(d[3]);

    accel.set(x/100, y/100, z/100);
    updateBars(x, y, z);
    render();
  }
}

// Atualiza barras 2D
function updateBars(x, y, z) {
  setBarPos("barX", x);
  setBarPos("barY", y);
  setBarPos("barZ", z);
}

function setBarPos(id, d) {
  var s = document.getElementById(id).style;
  if (d > 150) d = 150;
  if (d < -150) d = -150;
  if (d >= 0) {
    s.left = "150px";
    s.width = d + "px";
  } else {
    s.left = (150 + d) + "px";
    s.width = (-d) + "px";
  }
}

// WebGL com THREE.js
var scene, camera, renderer, cube;
function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, 1, 1, 10);
  camera.position.set(0, 3.5, 5);
  camera.lookAt(scene.position);

  cube = new THREE.Mesh(
    new THREE.BoxGeometry(2, 2, 2),
    new THREE.MeshNormalMaterial()
  );
  scene.add(cube);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(panel3d.clientWidth, panel3d.clientHeight);
  document.getElementById("panel3d").appendChild(renderer.domElement);
}
function render() {
  cube.lookAt(accel);
  renderer.render(scene, camera);
}

init3D();
render();
</script>
</body>
</html>
